<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Smart Waste Management Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; background:#eef3f8; color:#111; }
    header { background:#004080; color:white; padding:12px; text-align:center; font-size:22px; }
    #map { width:100%; height:65vh; border-bottom:3px solid #004080; }
    section { display:flex; flex-wrap:wrap; justify-content:space-around; padding:15px; }
    .card { background:white; border-radius:10px; padding:15px; margin:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); flex:1; min-width:260px; }
    h3 { color:#004080; margin-top:0; }
    button { background:#004080; color:white; border:none; padding:10px 15px; margin:3px; border-radius:6px; font-weight:bold; cursor:pointer; }
    button:hover { background:#0060b0; }
    #alerts { max-height:150px; overflow-y:auto; font-size:14px; }
    canvas { width:100%; height:150px; }
  </style>
</head>
<body>

<header>üè´ Smart Campus Waste Management ‚Äî AI Dashboard</header>

<div id="map"></div>

<section>
  <div class="card">
    <h3>AI Controls</h3>
    <button onclick="predictFills()">üîÆ Predict Bin Fill (AI)</button>
    <button onclick="assignVehicle()">üöó Assign Route (AI)</button>
    <button onclick="startAuto()">‚ñ∂ Start Auto</button>
    <button onclick="stopAuto()">‚èπ Stop Auto</button>
    <button onclick="resetSystem()">‚ôª Reset</button>
  </div>

  <div class="card">
    <h3>System Stats</h3>
    <p id="completedTrips">Completed Trips: 0</p>
    <p id="totalDistance">Total Distance: 0</p>
    <p id="avgETA">Avg ETA: 0</p>
    <p id="aiEfficiency">AI Efficiency: 0%</p>
  </div>

  <div class="card">
    <h3>AI Alerts</h3>
    <div id="alerts"></div>
  </div>

  <div class="card">
    <h3>Performance Chart</h3>
    <canvas id="tripChart"></canvas>
  </div>
</section>

<script>
const map = L.map('map').setView([22.0509, 88.0725], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let binMarkers = {};
let vehicleMarkers = {};
let routeLines = {};

function speak(msg) {
  try {
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(msg);
    utter.lang = 'en-IN';
    synth.speak(utter);
  } catch {}
}

function colorFromFill(fill) {
  if (fill >= 80) return "red";
  if (fill >= 50) return "orange";
  return "green";
}

async function loadBins() {
  const res = await fetch('/bins');
  const bins = await res.json();
  bins.forEach(b => {
    const color = colorFromFill(b.fill);
    const iconUrl = color === "red"
      ? "https://cdn-icons-png.flaticon.com/512/854/854878.png"
      : color === "orange"
      ? "https://cdn-icons-png.flaticon.com/512/2990/2990553.png"
      : "https://cdn-icons-png.flaticon.com/512/709/709496.png";
    const icon = L.icon({ iconUrl, iconSize:[36,36] });

    if (!binMarkers[b.id]) {
      binMarkers[b.id] = L.marker([b.lat, b.lng], { icon }).addTo(map);
    }
    binMarkers[b.id].setIcon(icon);
    binMarkers[b.id].bindPopup(`üóë Bin ${b.id}<br>Fill: ${b.fill}%`);
  });
}

async function loadVehicles() {
  const res = await fetch('/vehicles');
  const vehicles = await res.json();
  for (const v of vehicles) {
    const icon = L.icon({
      iconUrl:"https://cdn-icons-png.flaticon.com/512/3097/3097144.png",
      iconSize:[40,40]
    });
    if (!vehicleMarkers[v.id]) {
      vehicleMarkers[v.id] = L.marker([v.lat, v.lng], { icon }).addTo(map);
    } else {
      vehicleMarkers[v.id].setLatLng([v.lat, v.lng]);
    }
    vehicleMarkers[v.id].bindPopup(`üöõ Vehicle ${v.id}<br>Status: ${v.status}`);
    if (v.target_bin) drawRoute(v.id, v.lat, v.lng, v.target_bin);
  }
}

async function drawRoute(vehicleId, vlat, vlng, binId) {
  const res = await fetch('/bins');
  const bins = await res.json();
  const bin = bins.find(b => b.id === binId);
  if (!bin) return;
  if (routeLines[vehicleId]) map.removeControl(routeLines[vehicleId]);
  routeLines[vehicleId] = L.Routing.control({
    waypoints: [L.latLng(vlat, vlng), L.latLng(bin.lat, bin.lng)],
    lineOptions: { styles: [{ color:'purple', weight:4, opacity:0.7 }] },
    addWaypoints: false,
    draggableWaypoints: false,
    fitSelectedRoutes: false,
    createMarker: () => null
  }).addTo(map);
}

async function loadAlerts() {
  const res = await fetch('/alerts');
  const alerts = await res.json();
  document.getElementById("alerts").innerHTML =
    alerts.slice(-8).reverse().map(a => `üïí ${a.time} ‚Äî ${a.msg}`).join("<br>");
}

async function loadStats() {
  const res = await fetch('/stats');
  const s = await res.json();
  document.getElementById("completedTrips").innerText = "Completed Trips: " + s.completed;
  document.getElementById("totalDistance").innerText = "Total Distance: " + Math.round(s.distance) + " m";
  document.getElementById("avgETA").innerText = "Avg ETA: " + Math.round(s.avg_eta) + " s";
  document.getElementById("aiEfficiency").innerText = "AI Efficiency: " + (s.ai_efficiency || 0) + "%";
  updateChart(s.completed);
}

async function predictFills() {
  await fetch('/predict_fills', { method: 'POST' });
  speak("AI predicting bin fill levels...");
  await refresh();
}

async function assignVehicle() {
  await fetch('/assign_nearest_full', { method: 'POST' });
  speak("AI assigning the nearest vehicle...");
  await refresh();
}

async function startAuto() {
  await fetch('/start_auto', { method: 'POST' });
  speak("AI Auto mode started.");
}

async function stopAuto() {
  await fetch('/stop_auto', { method: 'POST' });
  speak("Auto mode stopped.");
}

async function resetSystem() {
  await fetch('/reset', { method: 'POST' });
  speak("System has been reset.");
  await refresh();
}

let chart;
function updateChart(val) {
  const ctx = document.getElementById('tripChart').getContext('2d');
  if (!chart) {
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label:'Trips', data:[], borderColor:'#004080', fill:false }] },
      options: { scales: { y: { beginAtZero:true } } }
    });
  }
  chart.data.labels.push(new Date().toLocaleTimeString());
  chart.data.datasets[0].data.push(val);
  if (chart.data.labels.length > 10) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

async function refresh() {
  await loadBins();
  await loadVehicles();
  await loadStats();
  await loadAlerts();
}

setInterval(refresh, 3000);
refresh();
</script>

</body>
</html>
