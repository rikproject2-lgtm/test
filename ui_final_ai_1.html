<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Waste Management | AI Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin:0; font-family: 'Segoe UI', Arial, sans-serif; background:#f5f7fa; color:#222; }
    header { background:#004080; color:white; padding:14px; text-align:center; font-size:22px; }
    #map { height:70vh; width:100%; border-bottom:2px solid #ccc; }
    section { padding:15px; display:flex; flex-wrap:wrap; justify-content:space-between; }
    .card { background:white; border-radius:10px; padding:15px; margin:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex:1; min-width:260px; }
    button { background:#004080; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-weight:bold; }
    button:hover { background:#0060a0; }
    #alerts { max-height:160px; overflow-y:auto; font-size:14px; line-height:1.6; }
    canvas { width:100%; height:150px; }
    h3 { margin-top:0; color:#004080; }
  </style>
</head>
<body>

<header>üè´ Smart Campus Waste Management ‚Äî AI-Enabled Dashboard</header>

<div id="map"></div>

<section>
  <div class="card">
    <h3>AI Operations</h3>
    <button onclick="predictFills()">üîÆ Predict Bin Fill (AI)</button>
    <button onclick="assignVehicle()">üöó Assign Route (AI Optimized)</button>
    <button onclick="startAuto()">‚ñ∂ Start Auto Mode</button>
    <button onclick="stopAuto()">‚èπ Stop Auto Mode</button>
    <button onclick="resetAll()">‚ôª Reset System</button>
  </div>

  <div class="card">
    <h3>System Insights</h3>
    <p id="completedTrips">Completed Trips: 0</p>
    <p id="totalDistance">Total Distance: 0 m</p>
    <p id="avgETA">Avg ETA: 0 s</p>
    <p id="aiEfficiency">AI Efficiency Gain: 0%</p>
  </div>

  <div class="card">
    <h3>Performance Chart</h3>
    <canvas id="tripChart"></canvas>
  </div>

  <div class="card">
    <h3>Alerts & AI Predictions</h3>
    <div id="alerts"></div>
  </div>
</section>

<script>
const map = L.map('map').setView([22.0509, 88.0725], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let binMarkers = {};
let vehicleMarkers = {};

async function loadBins() {
  const res = await fetch('/bins');
  const bins = await res.json();
  bins.forEach(b => {
    const color = b.status === "FULL" ? "red" : "green";
    const icon = L.icon({
      iconUrl: color === "red"
        ? "https://cdn-icons-png.flaticon.com/512/854/854878.png"
        : "https://cdn-icons-png.flaticon.com/512/709/709496.png",
      iconSize: [38, 38]
    });
    if (!binMarkers[b.id]) {
      binMarkers[b.id] = L.marker([b.lat, b.lng], { icon }).addTo(map);
    }
    binMarkers[b.id].bindPopup(`Bin ${b.id}<br>Fill: ${b.fill}%<br>Status: ${b.status}`);
  });
}

async function loadVehicles() {
  const res = await fetch('/vehicles');
  const vehicles = await res.json();
  vehicles.forEach(v => {
    const icon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/3097/3097144.png",
      iconSize: [40, 40]
    });
    if (!vehicleMarkers[v.id]) {
      vehicleMarkers[v.id] = L.marker([v.lat, v.lng], { icon }).addTo(map);
    } else {
      vehicleMarkers[v.id].setLatLng([v.lat, v.lng]);
    }
    vehicleMarkers[v.id].bindPopup(`Vehicle ${v.id}<br>Status: ${v.status}`);
  });
}

async function loadStats() {
  const res = await fetch('/stats');
  const s = await res.json();
  document.getElementById("completedTrips").innerText = "Completed Trips: " + s.completed;
  document.getElementById("totalDistance").innerText = "Total Distance: " + Math.round(s.distance) + " m";
  document.getElementById("avgETA").innerText = "Avg ETA: " + Math.round(s.avg_eta) + " s";
  document.getElementById("aiEfficiency").innerText = "AI Efficiency Gain: " + (s.ai_efficiency || 0) + "%";
  updateChart(s.trips_over_time || []);
}

async function loadAlerts() {
  const res = await fetch('/alerts');
  const alerts = await res.json();
  const div = document.getElementById("alerts");
  div.innerHTML = alerts.slice(-10).reverse().map(a => `<div>üïí ${a.time} ‚Äî ${a.msg}</div>`).join('');
}

function predictFills() { fetch('/predict_fills', { method: 'POST' }); }
function assignVehicle() { fetch('/assign_nearest_full', { method: 'POST' }); }
function startAuto() { fetch('/start_auto', { method: 'POST' }); }
function stopAuto() { fetch('/stop_auto', { method: 'POST' }); }
function resetAll() { fetch('/reset', { method: 'POST' }); }

let chart;
function updateChart(trips) {
  const ctx = document.getElementById('tripChart').getContext('2d');
  if (!chart) {
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Trips Completed', data: [], fill:false, borderColor:'#004080', tension:0.2 }] },
      options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
  }
  chart.data.labels = trips.map(t => t.time);
  chart.data.datasets[0].data = trips.map(t => t.completed);
  chart.update();
}

async function refresh() {
  await Promise.all([loadBins(), loadVehicles(), loadStats(), loadAlerts()]);
}
setInterval(refresh, 2500);
refresh();
</script>

</body>
</html>
