<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Driver Dashboard | Smart Waste Vehicle</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { margin:0; font-family:Arial; background:#eef3f8; }
    header { background:#004080; color:white; text-align:center; padding:12px; font-size:20px; }
    #map { height:85vh; width:100%; }
    #info { background:white; padding:10px; text-align:center; font-size:16px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<header>ðŸš› Smart Waste Vehicle â€” Driver Dashboard</header>
<div id="info">Loading assignment...</div>
<div id="map"></div>

<script>
const map = L.map('map').setView([22.0509, 88.0725], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const params = new URLSearchParams(window.location.search);
const vehicleId = params.get("id") || 1;

let vehicleMarker, binMarker, routeLine;

function speak(text) {
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "en-IN";
  synth.speak(utter);
}

async function updateDriver() {
  const res = await fetch(`/driver/${vehicleId}`);
  const data = await res.json();
  const info = document.getElementById("info");

  if (data.status === "IDLE") {
    info.innerHTML = `<b>Vehicle ${vehicleId}</b>: No active assignment yet.`;
    return;
  }

  if (data.status === "ASSIGNED") {
    const v = data.vehicle_location;
    const b = data.assigned_bin;
    info.innerHTML = `
      <b>Vehicle ${vehicleId}</b> â†’ Bin ${b.id}<br>
      Fill Level: ${b.fill}%<br>
      ETA: ${data.eta_seconds}s<br>
      Destination: (${b.lat.toFixed(5)}, ${b.lng.toFixed(5)})`;

    const vehIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/3097/3097144.png",
      iconSize: [40, 40]
    });
    const binIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/854/854878.png",
      iconSize: [38, 38]
    });

    if (!vehicleMarker) vehicleMarker = L.marker([v.lat, v.lng], { icon: vehIcon }).addTo(map);
    else vehicleMarker.setLatLng([v.lat, v.lng]);

    if (!binMarker) binMarker = L.marker([b.lat, b.lng], { icon: binIcon }).addTo(map);
    else binMarker.setLatLng([b.lat, b.lng]);

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([[v.lat, v.lng], [b.lat, b.lng]], { color:'purple', weight:5, opacity:0.6 }).addTo(map);

    speak(`Proceed to Bin ${b.id}. Estimated time ${data.eta_seconds} seconds.`);
  }
}

setInterval(updateDriver, 4000);
updateDriver();
</script>

</body>
</html>
